<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>üí¨ DarkyBot - Chat Tornasol Pro (Men√∫s ordenados)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; font-family: "Poppins", "Segoe UI", sans-serif; }
    body { margin: 0; background: radial-gradient(circle at top right, #ffffff12 0%, #000000 80%); color: #fff; display: flex; align-items: center; justify-content: center; height: 100dvh; overflow: hidden; }
    .chat-container { width: 100%; max-width: 420px; height: 100dvh; max-height: 820px; background: rgba(18,18,18,0.95); border-radius: 10px; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 6px 30px rgba(0,0,0,0.6); display: flex; flex-direction: column; overflow: hidden; position: relative; }
    .chat-container::before { content: ""; position: absolute; inset: 0; padding: 2px; background: linear-gradient(135deg, #ffffff, #d3f8ff, #fff0ff, #ffffff); background-size: 400% 400%; -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: glow 8s linear infinite; pointer-events: none; z-index: 0; border-radius: 10px; }
    @keyframes glow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .chat-header { z-index:1; background: rgba(255,255,255,0.04); padding: 16px; text-align: center; font-weight: 600; font-size: 1.05rem; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.04); }
    .chat-box { z-index:1; flex:1; padding: 18px; overflow-y:auto; display:flex; flex-direction:column; gap:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.15)); }
    .msg { max-width: 82%; padding: 12px 14px; border-radius: 10px; font-size: 14.5px; word-break: break-word; border: 1px solid rgba(255,255,255,0.04); backdrop-filter: blur(4px); }
    .bot { align-self: flex-start; background: linear-gradient(90deg,#f3e7ff,#ffffff); color: #000; border-radius: 10px 10px 10px 3px; }
    .user { align-self: flex-end; background: linear-gradient(90deg,#ffffff,#c7f5ff); color:#000; border-radius: 10px 10px 3px 10px; }
    .input-area { z-index:1; display:flex; border-top: 1px solid rgba(255,255,255,0.04); background: rgba(0,0,0,0.2); padding: 8px; gap:8px; }
    .input-area input { flex:1; border:none; padding:12px; background: transparent; color: #fff; outline:none; font-size: 15px; border-radius:6px; }
    .input-area button { background: linear-gradient(90deg,#ffffff,#c7f5ff,#ffffff); border:none; padding: 10px 16px; font-weight:700; cursor:pointer; color:#000; border-radius:6px; }
    .small { font-size:12px; opacity:0.9; }
    ol.menu { margin:8px 0 0 18px; padding:0; color: inherit; }
    ol.menu li { margin:6px 0; line-height:1.4; }
    .note { font-size:13px; color:#333; display:block; margin-top:8px; }
    ::-webkit-scrollbar{ width:8px; } ::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.08); border-radius:8px; }
    pre { margin: 0; white-space: pre-wrap; font-family: inherit; font-size: 14px; }
  </style>
</head>
<body>
  <div class="chat-container" role="main" aria-label="DarkyBot chat">
    <div class="chat-header">üí¨ DarkyBot ‚Äî Tornasol Pro</div>
    <div class="chat-box" id="chatBox" aria-live="polite"></div>
    <div class="input-area">
      <input id="userInput" type="text" placeholder="Escribe tu mensaje y presiona Enter..." autocomplete="off" />
      <button onclick="sendMessage()">Enviar</button>
    </div>
  </div>

<script>
/* DarkyBot Tornasol Pro - Men√∫s ordenados verticales */

// DOM
const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');

// Estados
let stage = 0;
let userName = '';
let userPurposeIndex = null;
let userBudget = 0;
let userBudgetLabel = '';
let lastConfigs = [];
let userLastChoice = null;
const EXCESS_LIMIT = 500000;

// Componentes y templates (precios aproximados COP)
const parts = {
  cpu: {
    low: {name: "Ryzen 3 4100", price: 350000},
    mid: {name: "Ryzen 5 5600X", price: 699000},
    mid_plus: {name: "i5-12400F", price: 650000},
    high: {name: "Ryzen 7 7700X", price: 1250000},
    top: {name: "Ryzen 9 7900X", price: 2100000}
  },
  ram: {
    ddr4_16: {name: "RAM 16GB DDR4", price: 245900},
    ddr5_32: {name: "RAM 32GB DDR5", price: 520000},
    ddr5_64: {name: "RAM 64GB DDR5", price: 1040000}
  },
  gpu: {
    gtx1650: {name: "GTX 1650 4GB", price: 700000},
    rtx3060: {name: "RTX 3060 12GB", price: 1800000},
    rtx4060: {name: "RTX 4060 8GB", price: 2200000},
    rtx4070: {name: "RTX 4070 12GB", price: 3000000}
  },
  ssd: {
    ssd500: {name: "SSD 500GB", price: 250000},
    ssd1tb: {name: "SSD 1TB NVMe", price: 480000},
    ssd2tb: {name: "SSD 2TB NVMe", price: 950000}
  },
  board: {
    b550: {name: "Placa Madre B550", price: 480000},
    x670: {name: "Placa Madre X670", price: 780000},
    x670e: {name: "Placa Madre X670E", price: 1200000}
  },
  psu: {
    w600: {name: "Fuente 600W", price: 220000},
    w750: {name: "Fuente 750W", price: 380000},
    w850: {name: "Fuente 850W", price: 580000}
  }
};

const purposeTemplates = [
  { cpu: 'mid', ram: 'ddr4_16', gpu: 'gtx1650', ssd: 'ssd500', board: 'b550', psu: 'w600' },
  { cpu: 'mid', ram: 'ddr4_16', gpu: 'rtx3060', ssd: 'ssd1tb', board: 'b550', psu: 'w750' },
  { cpu: 'high', ram: 'ddr5_32', gpu: 'rtx4060', ssd: 'ssd2tb', board: 'x670', psu: 'w750' },
  { cpu: 'high', ram: 'ddr5_32', gpu: 'rtx4060', ssd: 'ssd1tb', board: 'x670', psu: 'w850' },
  { cpu: 'top', ram: 'ddr5_64', gpu: 'rtx4070', ssd: 'ssd2tb', board: 'x670e', psu: 'w850' }
];

const budgetRanges = [
  { label: "Hasta 2 millones", value: 2000000 },
  { label: "Hasta 4 millones", value: 4000000 },
  { label: "Hasta 6 millones", value: 6000000 },
  { label: "Hasta 8 millones", value: 8000000 },
  { label: "Hasta 10 millones o m√°s", value: 10000000 }
];

// Helpers
function appendMessage(sender, htmlContent, small=false){
  const d = document.createElement('div');
  d.className = 'msg ' + (sender==='bot' ? 'bot' : 'user');
  if(small) d.classList.add('small');
  d.innerHTML = htmlContent;
  chatBox.appendChild(d);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function formatCOP(n){ return n.toLocaleString('es-CO'); }
function sumComponents(list){ return list.reduce((a,p)=>a+(p.price||0),0); }

function buildConfigFromTemplate(template){
  const c = [];
  c.push(parts.cpu[template.cpu]);
  c.push(parts.ram[template.ram]);
  c.push(parts.gpu[template.gpu]);
  c.push(parts.ssd[template.ssd]);
  c.push(parts.board[template.board]);
  c.push(parts.psu[template.psu]);
  return c;
}

// Ajuste iterativo para entrar en budget + EXCESS_LIMIT
function adjustConfigToBudget(config, budgetMax){
  let conf = config.slice();
  const maxAllowed = budgetMax + EXCESS_LIMIT;
  if(sumComponents(conf) <= maxAllowed) return {config: conf, total: sumComponents(conf)};

  const downgradeLists = {
    gpu: ['rtx4070','rtx4060','rtx3060','gtx1650'],
    ram: ['ddr5_64','ddr5_32','ddr4_16'],
    cpu: ['top','high','mid_plus','mid','low'],
    ssd: ['ssd2tb','ssd1tb','ssd500'],
    board: ['x670e','x670','b550'],
    psu: ['w850','w750','w600']
  };

  // map current items by category key
  const findKey = (part) => {
    for(const cat in parts){
      for(const code in parts[cat]){
        if(parts[cat][code].name === part.name) return {cat, code};
      }
    }
    return null;
  };

  let changed = true;
  while(sumComponents(conf) > maxAllowed && changed){
    changed = false;
    // try downgrades in order
    for(const cat of ['gpu','ram','cpu','ssd','board','psu']){
      // find index of current code
      let idx = -1;
      for(let i=0;i<conf.length;i++){
        const k = findKey(conf[i]);
        if(k && k.cat === cat){ idx = downgradeLists[cat].indexOf(k.code); break; }
      }
      if(idx === -1) continue;
      // attempt to replace with next cheaper
      for(let j=idx+1;j<downgradeLists[cat].length;j++){
        const code = downgradeLists[cat][j];
        const candidate = parts[cat][code];
        if(!candidate) continue;
        // replace in conf
        for(let i=0;i<conf.length;i++){
          const k = findKey(conf[i]);
          if(k && k.cat === cat){
            conf[i] = candidate;
            changed = true;
            break;
          }
        }
        if(changed) break;
      }
      if(sumComponents(conf) <= maxAllowed) break;
    }
  }
  return { config: conf, total: sumComponents(conf) };
}

function generateConfigs(purposeIndex, budgetMax){
  const template = purposeTemplates[purposeIndex];
  const base = buildConfigFromTemplate(template);

  const configs = [];

  // 1 - Ideal ajustado
  const ideal = adjustConfigToBudget(base, budgetMax);
  configs.push({ title: "Configuraci√≥n sugerida (optimizada)", parts: ideal.config, total: ideal.total, note: ideal.total > budgetMax ? `Se excede ${formatCOP(ideal.total - budgetMax)} COP.` : null });

  // 2 - Econ√≥mica (intento obtener versi√≥n m√°s barata)
  const cheapTemp = JSON.parse(JSON.stringify(template));
  // heur√≠sticos de downgrade
  if(cheapTemp.gpu === 'rtx4070') cheapTemp.gpu = 'rtx4060';
  if(cheapTemp.gpu === 'rtx4060') cheapTemp.gpu = 'rtx3060';
  if(cheapTemp.cpu === 'top') cheapTemp.cpu = 'high';
  if(cheapTemp.ram === 'ddr5_64') cheapTemp.ram = 'ddr5_32';
  if(cheapTemp.ssd === 'ssd2tb') cheapTemp.ssd = 'ssd1tb';
  if(cheapTemp.board === 'x670e') cheapTemp.board = 'x670';
  const cheap = adjustConfigToBudget(buildConfigFromTemplate(cheapTemp), budgetMax);
  configs.push({ title: "Alternativa econ√≥mica (ajustada)", parts: cheap.config, total: cheap.total, note: cheap.total > budgetMax ? `Se excede ${formatCOP(cheap.total - budgetMax)} COP.` : null });

  // 3 - Performance (prioriza GPU si cabe)
  const perfTemp = JSON.parse(JSON.stringify(template));
  const orderGpu = ['gtx1650','rtx3060','rtx4060','rtx4070'];
  // set to next gpu if possible
  let currentGpu = template.gpu;
  let idx = orderGpu.indexOf(currentGpu);
  if(idx < orderGpu.length - 1) perfTemp.gpu = orderGpu[idx + 1];
  const perf = adjustConfigToBudget(buildConfigFromTemplate(perfTemp), budgetMax);
  if(perf.total <= budgetMax + EXCESS_LIMIT) {
    configs.push({ title: "Alternativa enfocada en GPU", parts: perf.config, total: perf.total, note: perf.total > budgetMax ? `Se excede ${formatCOP(perf.total - budgetMax)} COP para priorizar GPU.` : null });
  } else {
    // fallback: repeat ideal (evita duplicados luego)
    configs.push({ title: "Alternativa balanceada", parts: ideal.config, total: ideal.total, note: ideal.total > budgetMax ? `Se excede ${formatCOP(ideal.total - budgetMax)} COP.` : null });
  }

  // Unificar √∫nicos
  const unique = [];
  const seen = new Set();
  for(const c of configs){
    const key = c.parts.map(p=>p.name).join('|') + '|' + Math.round(c.total/1000);
    if(!seen.has(key)){ unique.push(c); seen.add(key); }
  }
  return unique.slice(0,3);
}

function configToHtml(cfg){
  let s = '<ol class="menu">';
  cfg.parts.forEach(p => s += `<li>${p.name}: $${formatCOP(p.price)} COP</li>`);
  s += `</ol><p class="small">üí∞ Total estimado: $${formatCOP(cfg.total)} COP</p>`;
  if(cfg.note) s += `<p class="small">‚ö†Ô∏è ${cfg.note}</p>`;
  return s;
}

// INTERACCI√ìN

userInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendMessage(); });

function sendMessage(){
  const txt = userInput.value.trim();
  if(!txt) return;
  appendMessage('user', escapeHtml(txt));
  userInput.value = '';
  setTimeout(()=> {
    const botHtml = getBotResponse(txt);
    appendMessage('bot', botHtml);
  }, 300);
}

function mostrarRangosPresupuesto(){
  let s = '<p>Elige un rango de presupuesto (escribe el n√∫mero):</p><ol class="menu">';
  budgetRanges.forEach((r,i) => s += `<li><strong>${i+1}.</strong> ${r.label}</li>`);
  s += `<li><strong>6.</strong> Volver atr√°s</li></ol>`;
  return s;
}

function mostrarProp√≥sitos(){
  const labels = ['Oficina b√°sica','Gaming casual','Edici√≥n/Creaci√≥n de contenido','Streaming','Alta gama profesional'];
  let s = `<p>Genial, ${escapeHtml(userName)}! üòé Para comenzar, ¬øpara qu√© quieres una PC?</p><ol class="menu">`;
  labels.forEach((lab,i)=> s += `<li><strong>${i+1}.</strong> ${lab}</li>`);
  s += `<li><strong>6.</strong> Volver atr√°s</li></ol>`;
  return s;
}

function mostrarOpcionesResumen(){
  let s = `<p>Ok ${escapeHtml(userName)}, estas son las opciones de PC seg√∫n tu presupuesto de <strong>$${formatCOP(userBudget)} COP (${escapeHtml(userBudgetLabel)})</strong>:</p><ol class="menu">`;
  const labels = ['B√°sica','Media','Alta'];
  labels.forEach((lab,i)=> s += `<li><strong>${i+1}.</strong> ${lab}</li>`);
  s += `<li><strong>6.</strong> Volver atr√°s</li></ol>`;
  return s;
}

function getBotResponse(input){
  const msg = input.toLowerCase().trim();

  // Stage 0 - saludo
  if(stage === 0){
    if(msg.includes('hola') || msg.includes('buenas')){
      stage = 1;
      return "‚ú® ¬°Hola! ¬øC√≥mo te llamas?";
    } else {
      return 'üëã Di "hola" para comenzar la conversaci√≥n.';
    }
  }

  // Stage 1 - nombre
  if(stage === 1){
    if(!/^[a-zA-Z√°√©√≠√≥√∫√º√±\s]{2,}$/.test(input)) return "Por favor, escribe un nombre v√°lido (sin n√∫meros).";
    userName = input.charAt(0).toUpperCase() + input.slice(1);
    stage = 2;
    return mostrarProp√≥sitos();
  }

  // Stage 2 - prop√≥sito
  if(stage === 2){
    const n = parseInt(msg);
    if(isNaN(n) || n < 1 || n > 6) return "‚ùå Opci√≥n inv√°lida. Por favor elige un n√∫mero del 1 al 6.";
    if(n === 6){ stage = 1; return "Volviendo atr√°s. ¬øC√≥mo te llamas?"; }
    userPurposeIndex = n - 1;
    stage = 3;
    return `<p>Perfecto, ${escapeHtml(userName)}. Elegiste <strong>${['Oficina b√°sica','Gaming casual','Edici√≥n/Creaci√≥n de contenido','Streaming','Alta gama profesional'][userPurposeIndex]}</strong>.</p>` + mostrarRangosPresupuesto();
  }

  // Stage 3 - rango de presupuesto
  if(stage === 3){
    const n = parseInt(msg);
    if(isNaN(n) || n < 1 || n > 6) return "‚ùå Opci√≥n inv√°lida. Elige un n√∫mero del 1 al 6.";
    if(n === 6){ stage = 2; return mostrarProp√≥sitos(); }
    userBudget = budgetRanges[n-1].value;
    userBudgetLabel = budgetRanges[n-1].label;
    stage = 4;
    lastConfigs = generateConfigs(userPurposeIndex, userBudget);

    // evaluar si template ideal excede mucho
    const template = purposeTemplates[userPurposeIndex];
    const baseCfg = buildConfigFromTemplate(template);
    const baseTotal = sumComponents(baseCfg);

    let reply = `<p>Perfecto. Tom√© tu presupuesto: <strong>${escapeHtml(userBudgetLabel)}</strong> ($${formatCOP(userBudget)} COP).</p>`;
    if(baseTotal > userBudget + EXCESS_LIMIT){
      reply += `<p>üòÖ Nota: el template ideal para tu elecci√≥n cuesta alrededor de <strong>$${formatCOP(baseTotal)} COP</strong>, que est√° por encima de tu rango.</p><p>No te preocupes ‚Äî te muestro opciones coherentes y adaptadas que respetan tu presupuesto (o se exceden como m√°ximo $${formatCOP(EXCESS_LIMIT)} si es necesario).</p>`;
    } else {
      reply += `<p>üëå Genial ‚Äî te muestro varias configuraciones adaptadas a ese presupuesto.</p>`;
    }

    // mostrar opciones en lista numerada
    reply += `<p>Elige una opci√≥n para ver detalles (escribe el n√∫mero), o 6 para volver atr√°s:</p><ol class="menu">`;
    lastConfigs.forEach((c,i) => {
      reply += `<li><strong>${i+1}.</strong> ${escapeHtml(c.title)} ‚Äî Total aproximado: $${formatCOP(c.total)} COP${c.note ? ` (‚ö†Ô∏è ${escapeHtml(c.note)})` : ''}</li>`;
    });
    reply += `<li><strong>6.</strong> Volver atr√°s</li></ol>`;
    return reply;
  }

  // Stage 4 - elegir config
  if(stage === 4){
    const n = parseInt(msg);
    if(isNaN(n)) return `Por favor, elige una opci√≥n v√°lida (1-${lastConfigs.length}) o 6 para volver atr√°s.`;
    if(n === 6){ stage = 3; return mostrarRangosPresupuesto(); }
    if(n < 1 || n > lastConfigs.length) return `Elige una opci√≥n entre 1 y ${lastConfigs.length} o 6 para volver.`;
    const chosen = lastConfigs[n-1];
    userLastChoice = chosen;
    let details = `<p>üñ•Ô∏è <strong>${escapeHtml(chosen.title)}</strong></p>`;
    details += configToHtml(chosen);
    details += `<p class="small">Si quer√©s otra alternativa escribe <strong>otra</strong>. Para aceptar escribe <strong>acepto</strong>. Para reiniciar escribe <strong>reiniciar</strong>. Para volver atr√°s escribe <strong>6</strong>.</p>`;
    stage = 5;
    return details;
  }

  // Stage 5 - acciones despu√©s de ver config
  if(stage === 5){
    if(msg === 'otra' || msg === 'otra opci√≥n' || msg === 'otra opcion'){
      lastConfigs = generateConfigs(userPurposeIndex, userBudget);
      stage = 4;
      let r = `<p>Perfecto, genero otras alternativas:</p><ol class="menu">`;
      lastConfigs.forEach((c,i)=> r += `<li><strong>${i+1}.</strong> ${escapeHtml(c.title)} ‚Äî $${formatCOP(c.total)} COP${c.note ? ` (‚ö†Ô∏è ${escapeHtml(c.note)})` : ''}</li>`);
      r += `<li><strong>6.</strong> Volver atr√°s</li></ol><p class="small">Escribe 1-${lastConfigs.length} para ver detalles, o 6 para volver atr√°s.</p>`;
      return r;
    }
    if(msg === 'reiniciar' || msg === 'reset' || msg === 'reinicia'){
      stage = 0; userName=''; userPurposeIndex=null; userBudget=0; lastConfigs=[]; userLastChoice=null;
      return 'üîÑ Reiniciando chat... Di "hola" cuando quieras volver a empezar.';
    }
    if(msg === '6'){
      stage = 3;
      return mostrarRangosPresupuesto();
    }
    if(msg.includes('acepto') || msg.includes('comprar') || msg.includes('lo quiero') || msg.includes('perfecto')){
      const chosen = userLastChoice || lastConfigs[0];
      let finish = `<p>Genial ${escapeHtml(userName)}, excelente elecci√≥n ‚úÖ. Resumen:</p>`;
      finish += configToHtml(chosen);
      if(chosen.total > userBudget) finish += `<p class="small">‚ö†Ô∏è Te excedes por $${formatCOP(chosen.total - userBudget)} COP. Pod√©s ajustar GPU o SSD para bajar precio.</p>`;
      finish += `<p class="small">Si quer√©s, puedo generar una lista de compra (escribe <strong>lista</strong>) o reiniciar (escribe <strong>reiniciar</strong>).</p>`;
      stage = 6;
      return finish;
    }
    if(msg === 'lista'){
      const chosen = userLastChoice || lastConfigs[0];
      let list = `<p>Lista de compra (componentes):</p><ol class="menu">`;
      chosen.parts.forEach(p => list += `<li>${escapeHtml(p.name)} - $${formatCOP(p.price)} COP</li>`);
      list += `</ol><p class="small">Total: $${formatCOP(chosen.total)} COP</p><p class="small">Si quer√©s reinici√° con "reiniciar".</p>`;
      return list;
    }
    return 'No entend√≠ esa acci√≥n. Responde con "otra", "acepto", "lista", "reiniciar" o escribe 6 para volver atr√°s.';
  }

  if(stage === 6){
    if(msg.includes('reiniciar') || msg.includes('reset')){
      stage = 0; userName=''; userPurposeIndex=null; userBudget=0; lastConfigs=[]; userLastChoice=null;
      return 'üîÑ Reiniciado. Decime "hola" para comenzar de nuevo.';
    }
    return 'Si quer√©s reiniciar el chat escribe "reiniciar".';
  }

  return "No entend√≠, prob√° de nuevo (elige n√∫meros v√°lidos o escribe 'reiniciar' para empezar de nuevo).";
}

// Inicio
window.onload = () => {
  appendMessage('bot', 'üåà Bienvenido al DarkyBot Tornasol Pro. Decime "hola" para empezar!');
  userInput.focus();
};
</script>
</body>
</html>
